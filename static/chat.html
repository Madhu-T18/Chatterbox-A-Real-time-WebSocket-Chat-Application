<!DOCTYPE html>
<html>
<head>
    <title>ChatterBox</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div id="profileModal" style="display:none;">
    <input type="file" id="profileFile">
    <button onclick="uploadProfile()">Upload</button>
</div>
<div class="chat-container">

    <!-- SIDEBAR -->
    <div class="sidebar">

    <div class="sidebar-header">
        <h2>ChatterBox</h2>
        <div class="menu">
            <button onclick="toggleMenu()">â‹®</button>
            <div id="dropdownMenu" class="dropdown">
                <button onclick="openProfile()">Profile</button>
                <button onclick="openChangePassword()">Change Password</button>
                <button onclick="logout()">Logout</button>
                <button onclick="removeProfile()">Remove Profile</button>
            </div>
        </div>
    </div>

    <div id="userList"></div>

</div>

    <!-- CHAT WINDOW -->
    <div class="chat-window">

        <div class="chat-header" id="chatHeader">
            Select a user to start chatting
        </div>

        <div class="typing" id="typingIndicator"></div>

        <div class="messages" id="messages"></div>

        <div class="message-input">

            <input type="file" id="fileInput" style="display:none">
            <button onclick="document.getElementById('fileInput').click()">ðŸ“Ž</button>

            <button onclick="addEmoji('ðŸ˜Š')">ðŸ˜Š</button>
            <button onclick="addEmoji('ðŸ˜‚')">ðŸ˜‚</button>
            <button onclick="addEmoji('ðŸ”¥')">ðŸ”¥</button>

            <input type="text" id="messageInput" placeholder="Type a message">

            <button onclick="sendMessage()">Send</button>

        </div>

    </div>

</div>


<script>
let token = localStorage.getItem("token");
if (!token) {
    alert("Login required");
    window.location.href = "/";
}

let socket = null;
let selectedUserId = null;
let currentUserId = parseInt(localStorage.getItem("user_id"));

async function init() {
    await loadUsers();
    connectWebSocket();
}
init();

async function loadUsers() {
    const response = await fetch("http://localhost:8000/users");
    const users = await response.json();

    const container = document.getElementById("userList");
    container.innerHTML = "";

    users.forEach(user => {
        const div = document.createElement("div");
        div.className = "user";

        div.innerHTML = `
            <div style="display:flex; align-items:center;">
                <img src="/${user.profile_pic || 'static/default.png'}"
                     style="width:40px;height:40px;border-radius:50%;margin-right:10px;object-fit:cover;">

                <div>
                    <div>${user.username}</div>
                    <div style="font-size:12px;color:gray;">
                        ${user.about || ""}
                    </div>
                </div>
            </div>

            <span>
                ${user.is_online ? "Online" : "Offline"}
            </span>
        `;

        div.onclick = () => {
            document.querySelectorAll(".user").forEach(u =>
                u.classList.remove("active")
            );

            div.classList.add("active");
            selectedUserId = user.id;
            document.getElementById("chatHeader").innerText = user.username;
            loadMessages(user.id);
        };

        container.appendChild(div);
    });
}

async function loadMessages(receiverId) {
    const response = await fetch(
        `http://localhost:8000/messages/${receiverId}?token=${token}`
    );

    const messages = await response.json();
    const container = document.getElementById("messages");
    container.innerHTML = "";

    messages.forEach(msg => renderMessage(msg));
}

function connectWebSocket() {
    socket = new WebSocket(`ws://localhost:8000/ws?token=${token}`);

    socket.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "private_message") {
            renderMessage(data);
        }

        if (data.type === "typing") {
            const typingDiv = document.getElementById("typingIndicator");
            typingDiv.innerText = data.sender_name + " is typing...";
            setTimeout(() => typingDiv.innerText = "", 2000);
        }
    };
}

function sendMessage() {
    const input = document.getElementById("messageInput");
    const content = input.value.trim();

    if (!content || !selectedUserId) return;

    socket.send(JSON.stringify({
        type: "private_message",
        receiver_id: selectedUserId,
        content: content
    }));

    input.value = "";
}

document.getElementById("fileInput").addEventListener("change", async function() {
    if (!selectedUserId) return;

    const file = this.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append("file", file);

    await fetch(`http://localhost:8000/upload-file?token=${token}&receiver_id=${selectedUserId}`, {
        method: "POST",
        body: formData
    });

    this.value = "";
});

function renderMessage(msg) {
    const container = document.getElementById("messages");

    const div = document.createElement("div");
    div.classList.add("message");
    div.classList.add(
        msg.sender_id === currentUserId ? "sent" : "received"
    );

    if (msg.file_path) {
        div.innerHTML = `
            <a href="/${msg.file_path}" target="_blank">ðŸ“Ž Download File</a>
            <div class="timestamp">
                ${new Date(msg.timestamp).toLocaleTimeString()}
            </div>
        `;
    } else {
        div.innerHTML = `
            <div>${msg.content}</div>
            <div class="timestamp">
                ${new Date(msg.timestamp).toLocaleTimeString()}
            </div>
        `;
    }

    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function addEmoji(emoji) {
    const input = document.getElementById("messageInput");
    input.value += emoji;
}

function toggleMenu() {
    const menu = document.getElementById("dropdownMenu");
    menu.style.display =
        menu.style.display === "block" ? "none" : "block";
}

function logout() {
    localStorage.removeItem("token");
    localStorage.removeItem("user_id");
    window.location.href = "/";
}
function openProfile() {
    document.getElementById("profileModal").style.display = "block";
}

async function uploadProfile() {
    const fileInput = document.getElementById("profileFile");
    const token = localStorage.getItem("token");

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);
    formData.append("token", token);

    const response = await fetch("/upload-profile", {
        method: "POST",
        body: formData
    });

    const data = await response.json();
    alert(data.message);
}
async function removeProfile() {
    const token = localStorage.getItem("token");

    const response = await fetch("/remove-profile", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `token=${token}`
    });

    const data = await response.json();
    alert(data.message);

    location.reload(); // refresh UI
}
async function changePassword() {
    const oldPass = prompt("Enter old password:");
    const newPass = prompt("Enter new password:");

    if (!oldPass || !newPass) return;

    const response = await fetch("http://localhost:8000/change-password", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            token: token,
            old_password: oldPass,
            new_password: newPass
        })
    });

    const data = await response.json();
    alert(data.message || data.detail);
}
function toggleMenu() {
    const menu = document.getElementById("dropdownMenu");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
}


function logout() {
    localStorage.removeItem("token");
    localStorage.removeItem("user_id");
    window.location.href = "/";
}

function openChangePassword() {
    const oldPass = prompt("Enter old password:");
    const newPass = prompt("Enter new password:");

    fetch("/change-password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            token: localStorage.getItem("token"),
            old_password: oldPass,
            new_password: newPass
        })
    }).then(res => res.json())
      .then(data => alert(data.message || data.detail));
}

</script>

</body>
</html>
